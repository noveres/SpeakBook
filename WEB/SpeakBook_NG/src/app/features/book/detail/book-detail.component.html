<!-- 載入狀態 -->
<div *ngIf="isLoading" class="loading-container">
    <div class="spinner"></div>
    <p>載入中...</p>
</div>

<!-- 教材詳情 -->
<div *ngIf="!isLoading && book" class="book-detail-container">
    <!-- 返回按鈕 -->
    <button class="back-button" (click)="goBack()">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M19 12H5M12 19l-7-7 7-7" />
        </svg>
        返回列表
    </button>

    <div class="detail-content">
        <!-- 左側：封面圖片與熱區 -->
        <div class="cover-section">
            <div class="image-container">
                <img [src]="book.coverImageUrl || 'https://placehold.co/400x600/e0e0e0/757575?text=No+Image'"
                    [alt]="book.title" [title]="book.title" (error)="onImageError($event)" (load)="onImageLoad($event)"
                    class="cover-image" />

                <!-- 熱區顯示 -->
                <div class="hotspots-overlay" *ngIf="imageLoaded && hotspots.length > 0">
                    <div *ngFor="let hotspot of hotspots" class="hotspot"
                        [class.selected]="selectedHotspot?.id === hotspot.id"
                        [ngStyle]="getScaledHotspotStyle(hotspot)"
                        (click)="selectHotspot(hotspot)" [title]="hotspot.label">
                        <span class="hotspot-label">{{ hotspot.label }}</span>
                        <button class="play-audio-btn" *ngIf="hotspot.audioUrl" (click)="playAudio(hotspot); $event.stopPropagation()"
                            title="播放音訊">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                fill="currentColor">
                                <polygon points="5 3 19 12 5 21 5 3"></polygon>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- 熱區提示 -->
            <div class="hotspot-hint" *ngIf="hotspots.length > 0">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="16" x2="12" y2="12"></line>
                    <line x1="12" y1="8" x2="12.01" y2="8"></line>
                </svg>
                <span>點擊圖片上的熱區以查看詳細信息或播放音訊</span>
            </div>
        </div>

        <!-- 右側：教材資訊 -->
        <div class="info-section">
            <h1 class="book-title">{{ book.title }}</h1>

            <div class="book-meta">
                <div class="meta-item">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                    <span class="meta-label">作者：</span>
                    <span class="meta-value">{{ book.author }}</span>
                </div>

                <div class="meta-item">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="16" y1="2" x2="16" y2="6"></line>
                        <line x1="8" y1="2" x2="8" y2="6"></line>
                        <line x1="3" y1="10" x2="21" y2="10"></line>
                    </svg>
                    <span class="meta-label">出版日期：</span>
                    <span class="meta-value">{{ book.publishedAt | date:'yyyy-MM-dd' }}</span>
                </div>

                <div class="meta-item">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"></path>
                    </svg>
                    <span class="meta-label">頁數：</span>
                    <span class="meta-value">{{ book.pages }} 頁</span>
                </div>

                <div class="meta-item">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path>
                        <line x1="7" y1="7" x2="7.01" y2="7"></line>
                    </svg>
                    <span class="meta-label">分類：</span>
                    <span class="category-badge">{{ book.category }}</span>
                </div>
            </div>

            <div class="description-section">
                <h2>內容簡介</h2>
                <p class="description-text">{{ book.description }}</p>
            </div>

            <!-- 熱區列表 -->
            <div class="hotspots-section" *ngIf="hotspots.length > 0">
                <h2>互動熱區</h2>
                <div class="hotspots-list">
                    <div *ngFor="let hotspot of hotspots" class="hotspot-item"
                        [class.active]="selectedHotspot?.id === hotspot.id" (click)="selectHotspot(hotspot)">
                        <div class="hotspot-item-header">
                            <span class="hotspot-number">{{ hotspot.label }}</span>
                            <button class="play-btn-small" *ngIf="hotspot.audioUrl"
                                (click)="playAudio(hotspot); $event.stopPropagation()" title="播放音訊">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24"
                                    fill="currentColor">
                                    <polygon points="5 3 19 12 5 21 5 3"></polygon>
                                </svg>
                            </button>
                        </div>
                        <div class="hotspot-item-info">
                            <span>位置: ({{ hotspot.x }}, {{ hotspot.y }})</span>
                            <span>大小: {{ hotspot.width }} × {{ hotspot.height }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 操作按鈕 -->
            <div class="action-buttons">
                <!-- <button class="btn btn-primary" (click)="onEdit()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                    </svg>
                    編輯教材
                </button> -->
                <button class="btn btn-danger" (click)="onDelete()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>
                    刪除教材
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 未找到教材 -->
<div *ngIf="!isLoading && !book" class="not-found">
    <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor"
        stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="10"></circle>
        <line x1="12" y1="8" x2="12" y2="12"></line>
        <line x1="12" y1="16" x2="12.01" y2="16"></line>
    </svg>
    <h2>找不到教材</h2>
    <p>您查找的教材不存在或已被刪除</p>
    <button class="btn btn-primary" (click)="goBack()">返回列表</button>
</div>
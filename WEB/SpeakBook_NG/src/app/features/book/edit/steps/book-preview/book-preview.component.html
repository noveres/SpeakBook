<div class="preview-container">
    <!-- 左側：教材預覽 -->
    <div class="preview-section">
        <h3>教材預覽</h3>

        <!-- 圖片預覽 -->
        <div class="image-preview" *ngIf="uploadedImage">
            <div class="preview-image-wrapper">
                <img [src]="uploadedImage.url" [alt]="uploadedImage.name" />

                <!-- 熱區預覽 -->
                <div *ngFor="let hotspot of hotspots" class="preview-hotspot" 
                    [class.selected]="selectedHotspot?.id === hotspot.id"
                    [class.playing]="isPlaying(hotspot.id)"
                    [style.left.px]="hotspot.x"
                    [style.top.px]="hotspot.y" 
                    [style.width.px]="hotspot.width" 
                    [style.height.px]="hotspot.height"
                    (click)="selectHotspot(hotspot)">
                    <span class="hotspot-label">{{ hotspot.label }}</span>
                    <button class="play-audio-btn" *ngIf="hotspot.audioUrl"
                        (click)="playAudio(hotspot); $event.stopPropagation()"
                        [title]="isPlaying(hotspot.id) ? '停止播放' : '播放音訊'">
                        <!-- 播放圖標 -->
                        <svg *ngIf="!isPlaying(hotspot.id)" xmlns="http://www.w3.org/2000/svg" width="16"
                            height="16" viewBox="0 0 24 24" fill="currentColor">
                            <polygon points="5 3 19 12 5 21 5 3"></polygon>
                        </svg>
                        <!-- 暫停圖標 -->
                        <svg *ngIf="isPlaying(hotspot.id)" xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                            viewBox="0 0 24 24" fill="currentColor">
                            <rect x="6" y="4" width="4" height="16"></rect>
                            <rect x="14" y="4" width="4" height="16"></rect>
                        </svg>
                    </button>
                </div>
            </div>

            <div class="preview-stats">
                <div class="stat-item">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                        <circle cx="8.5" cy="8.5" r="1.5"></circle>
                        <polyline points="21 15 16 10 5 21"></polyline>
                    </svg>
                    <span>{{ uploadedImage.name }}</span>
                </div>
                <div class="stat-item">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="9" y1="9" x2="15" y2="15"></line>
                        <line x1="15" y1="9" x2="9" y2="15"></line>
                    </svg>
                    <span>{{ hotspots.length }} 個熱區</span>
                </div>
            </div>
        </div>

        <div class="no-image" *ngIf="!uploadedImage">
            <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                <circle cx="8.5" cy="8.5" r="1.5"></circle>
                <polyline points="21 15 16 10 5 21"></polyline>
            </svg>
            <p>尚未上傳圖片</p>
        </div>

        <!-- 熱區列表 -->
        <div class="hotspots-summary" *ngIf="hotspots.length > 0">
            <h4>熱區列表</h4>
            <div class="hotspot-list">
                <app-audio-card *ngFor="let hotspot of hotspots; let i = index" 
                    [data]="toAudioCardData(hotspot)"
                    [index]="i"
                    [isActive]="selectedHotspot?.id === hotspot.id"
                    [useExternalPlayback]="true"
                    [externalIsPlaying]="isPlaying(hotspot.id)"
                    [externalAudioCurrentTime]="isPlaying(hotspot.id) ? audioCurrentTime : 0"
                    [externalAudioDuration]="isPlaying(hotspot.id) ? audioDuration : 0"
                    (click)="selectHotspot(hotspot)"
                    (playToggle)="playAudio(hotspot)">
                </app-audio-card>
            </div>
        </div>
    </div>

    <!-- 右側：教材資訊 -->
    <div class="info-section">
        <h3>教材資訊</h3>

        <div class="book-info-card" *ngIf="settings">
            <div class="info-header">
                <h2>{{ settings.title || '未命名教材' }}</h2>
                <span class="category-badge">{{ settings.category }}</span>
            </div>

            <div class="info-row">
                <div class="info-item">
                    <label>作者</label>
                    <span>{{ settings.author || '未填寫' }}</span>
                </div>
                <div class="info-item">
                    <label>適用年齡</label>
                    <span>{{ settings.targetAge }}</span>
                </div>
            </div>

            <div class="info-row">
                <div class="info-item">
                    <label>難度等級</label>
                    <span class="difficulty-badge" [class]="'difficulty-' + settings.difficulty">{{
                        settings.difficulty }}</span>
                </div>
                <!-- <div class="info-item">
                    <label>頁數</label>
                    <span>{{ settings.pages || 0 }} 頁</span>
                </div> -->
            </div>

            <div class="info-description">
                <label>描述</label>
                <p>{{ settings.description || '尚未填寫描述' }}</p>
            </div>
        </div>

        <div class="no-settings" *ngIf="!settings">
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
            </svg>
            <p>尚未設定教材資訊</p>
        </div>

        <!-- 驗證狀態 -->
        <div class="validation-status">
            <h4>發布檢查</h4>
            <div class="validation-item" [class.valid]="isValid" [class.invalid]="!isValid">
                <svg *ngIf="isValid" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
                <svg *ngIf="!isValid" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="15" y1="9" x2="9" y2="15"></line>
                    <line x1="9" y1="9" x2="15" y2="15"></line>
                </svg>
                <span *ngIf="isValid">所有必填項目已完成，可以發布</span>
                <span *ngIf="!isValid">尚有未完成項目</span>
            </div>

            <ul class="validation-messages" *ngIf="!isValid">
                <li *ngFor="let message of validationMessages">{{ message }}</li>
            </ul>
        </div>

        <!-- 操作按鈕 -->
        <div class="action-buttons">
            <!-- <button class="draft-button" (click)="onSaveDraft()" [disabled]="isSavingDraft">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                    <polyline points="17 21 17 13 7 13 7 21"></polyline>
                    <polyline points="7 3 7 8 15 8"></polyline>
                </svg>
                {{ isSavingDraft ? '儲存中...' : '儲存草稿' }}
            </button> -->

            <button class="publish-button" (click)="onPublish()" [disabled]="!isValid || isPublishing">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M5 12h14"></path>
                    <path d="m12 5 7 7-7 7"></path>
                </svg>
                {{ isPublishing ? '發布中...' : '發布教材' }}
            </button>
        </div>
    </div>
</div>
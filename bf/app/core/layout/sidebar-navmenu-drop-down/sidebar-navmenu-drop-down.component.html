@if (isLoginPage) {
<router-outlet></router-outlet>
} @else {
<div class="app-container" [class.sidebar-collapsed]="!isSidebarActive">
  <!-- 頂部導航欄 -->
  <div class="top-header">
    <div class="header-right">
      @if(isPCMenuToggleEnabled){
      <!-- 主機端漢堡菜單按鈕 -->
      <button class="pc-menutoggle" aria-label="Toggle mobile menu" (click)="toggleSidebar()">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="3" y1="12" x2="21" y2="12"></line>
          <line x1="3" y1="6" x2="21" y2="6"></line>
          <line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
      </button>
      }

      <div class="logo-text">
        <span>{{ 'COMMON.SYSTEM_NAME' | translate }}</span>
      </div>
    </div>
    <div class="header-right">
      @if (isMobileMenuToggleEnabled) {
      <!-- 手機端漢堡菜單按鈕 -->
      <button class="mobile-menu-toggle" aria-label="Toggle mobile menu" (click)="toggleSidebar()">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="3" y1="12" x2="21" y2="12"></line>
          <line x1="3" y1="6" x2="21" y2="6"></line>
          <line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
      </button>
      }

      <!-- <app-refresh-token-test></app-refresh-token-test> -->
      <!-- <app-language-selector></app-language-selector> -->
      <app-user-menu-dropdown [userName]="userName" [userRole]="userRole" [avatarUrl]="avatarUrl"
        [showDefaultAvatar]="showDefaultAvatar" (logoutEvent)="logout()"></app-user-menu-dropdown>
    </div>
  </div>


  <!-- 主體內容區域 -->
  <div class="main-container">
    <!-- 側邊欄 -->
    <div class="sidebar" [class.active]="isSidebarActive">
      <!-- 用戶資料 -->
      <div class="user-profile">
        <div class="avatar-container">
          <img *ngIf="!showDefaultAvatar && avatarUrl" [src]="avatarUrl" alt="User Avatar" width="50" height="50"
            (error)="handleAvatarError()" />
          <svg *ngIf="showDefaultAvatar || !avatarUrl" xmlns="http://www.w3.org/2000/svg" width="50" height="50"
            viewBox="0 0 50 50">
            <circle cx="25" cy="25" r="25" fill="#f0f0f0" />
            <circle cx="25" cy="20" r="8" fill="#999" />
            <path d="M25,28 C17,28 11,32 11,38 L39,38 C39,32 33,28 25,28 Z" fill="#999" />
          </svg>
        </div>
        <div class="user-info">
          <div class="user-name">{{ userName }}</div>
          <div class="user-role">{{ userRole || "_" }}</div>
        </div>
        <button class="menu-toggle" aria-label="Toggle sidebar" (click)="toggleSidebar()">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="#FF5733" stroke="currentColor"
            stroke-width="2" viewBox="0 0 16 16">
            @if (isMenuToggleOffVisible){
            <path *ngIf="!isSidebarActive"
              d="M5.5 8a.5.5 0 0 1 .5-.5h6.293l-3.147-3.146a.5.5 0 0 1 .708-.708l4 4a.5.5 0 0 1 0 .708l-4 4a.5.5 0 0 1-.708.708L12.293 8.5H6a.5.5 0 0 1-.5-.5z" />
            }
            @if (isMenuToggleOnVisible){
            <path *ngIf="isSidebarActive"
              d="M10.5 8a.5.5 0 0 1-.5.5H3.707l3.147 3.146a.5.5 0 0 1-.708.708l-4-4a.5.5 0 0 1 0-.708l4-4a.5.5 0 1 1 .708.708L3.707 7.5H10a.5.5 0 0 1 .5.5z" />
            }
          </svg>
        </button>
      </div>

      <!-- 導航菜單 -->
      <div class="nav-menu">
        <ul>
          <li>
            <a routerLink="/home" routerLinkActive="active">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                class="lucide lucide-home-icon lucide-home">
                <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" />
                <polyline points="9,22 9,12 15,12 15,22" />
              </svg> <span>{{ 'SIDEBAR.HOME' | translate }}</span>
            </a>
          </li>



          <!-- 教材管理選項 -->
          <li class="menu-item-with-submenu">
            <a href="javascript:void(0)" (click)="toggleSubmenu('bookManagement')">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                class="lucide lucide-book">
                <path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20" />
              </svg>
              <span>{{ 'SIDEBAR.BOOK_MANAGEMENT' | translate }}</span>
              <svg class="submenu-arrow" [class.rotated]="isSubmenuExpanded('bookManagement')"
                xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                <path fill-rule="evenodd"
                  d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z" />
              </svg>
            </a>
            <ul class="submenu" [class.active]="isSubmenuExpanded('bookManagement')">
              <li>
                <a routerLink="/book" routerLinkActive="active">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                    viewBox="0 0 16 16">
                    <path
                      d="M1 2.828c.885-.37 2.154-.769 3.388-.893 1.33-.134 2.458.063 3.112.752v9.746c-.935-.53-2.12-.603-3.213-.493-1.18.12-2.37.461-3.287.811V2.828zm7.5-.141c.654-.689 1.782-.886 3.112-.752 1.234.124 2.503.523 3.388.893v9.923c-.918-.35-2.107-.692-3.287-.81-1.094-.111-2.278-.039-3.213.492V2.687zM8 1.783C7.015.936 5.587.81 4.287.94c-1.514.153-3.042.672-3.994 1.105A.5.5 0 0 0 0 2.5v11a.5.5 0 0 0 .707.455c.882-.4 2.303-.881 3.68-1.02 1.409-.142 2.59.087 3.223.877a.5.5 0 0 0 .78 0c.633-.79 1.814-1.019 3.222-.877 1.378.139 2.8.62 3.681 1.02A.5.5 0 0 0 16 13.5v-11a.5.5 0 0 0-.293-.455c-.952-.433-2.48-.952-3.994-1.105C10.413.809 8.985.936 8 1.783z" />
                  </svg>
                  <span>{{ 'SIDEBAR.BOOK_LIST' | translate }}</span>
                </a>
              </li>
              <li>
                <a routerLink="/create" routerLinkActive="active">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                    viewBox="0 0 16 16">
                    <path
                      d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z" />
                    <path
                      d="M1 2.828c.885-.37 2.154-.769 3.388-.893 1.33-.134 2.458.063 3.112.752v9.746c-.935-.53-2.12-.603-3.213-.493-1.18.12-2.37.461-3.287.811V2.828zm7.5-.141c.654-.689 1.782-.886 3.112-.752 1.234.124 2.503.523 3.388.893v9.923c-.918-.35-2.107-.692-3.287-.81-1.094-.111-2.278-.039-3.213.492V2.687zM8 1.783C7.015.936 5.587.81 4.287.94c-1.514.153-3.042.672-3.994 1.105A.5.5 0 0 0 0 2.5v11a.5.5 0 0 0 .707.455c.882-.4 2.303-.881 3.68-1.02 1.409-.142 2.59.087 3.223.877a.5.5 0 0 0 .78 0c.633-.79 1.814-1.019 3.222-.877 1.378.139 2.8.62 3.681 1.02A.5.5 0 0 0 16 13.5v-11a.5.5 0 0 0-.293-.455c-.952-.433-2.48-.952-3.994-1.105C10.413.809 8.985.936 8 1.783z" />
                  </svg>
                  <span>{{ 'SIDEBAR.BOOK_CREATE' | translate }}</span>
                </a>
              </li>
            </ul>
          </li>

          <li>
            <a href="javascript:void(0)" (click)="logout()">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                <path fill-rule="evenodd"
                  d="M10 12.5a.5.5 0 0 1-.5.5h-8a.5.5 0 0 1-.5-.5v-9a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 .5.5v2a.5.5 0 0 0 1 0v-2A1.5 1.5 0 0 0 9.5 2h-8A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h8a1.5 1.5 0 0 0 1.5-1.5v-2a.5.5 0 0 0-1 0v2z" />
                <path fill-rule="evenodd"
                  d="M15.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 0 0-.708.708L14.293 7.5H5.5a.5.5 0 0 0 0 1h8.793l-2.147 2.146a.5.5 0 0 0 .708.708l3-3z" />
              </svg>
              <span>{{ 'COMMON.LOGOUT' | translate }}</span>
            </a>
          </li>
        </ul>
        <!-- 移動端滑動空間容器 -->
        <div class="mobile-scroll-spacer"></div>
      </div>

    </div>


    <!-- 主要內容 -->
    <div class="main-content">
      <div class="content-wrapper">
        <router-outlet></router-outlet>
      </div>
    </div>

    <!-- 路由導航加載動畫 -->
    <app-loading-spinner [isLoading]="isNavigating" [text]="'SIDEBAR.LOADING_TEXT' | translate">
    </app-loading-spinner>
  </div>
</div>

<!-- 登錄頁面模板 -->
<ng-template #loginTemplate>
  <router-outlet></router-outlet>
</ng-template>
}